<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JAKSAFEMap: Live Danger Zone Analyzer</title>
  <script type="text/javascript" src="https://ff.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=55cs1Z2QzTptuhyENcgo6dYH-t1CZkp2mWqNsUvzDCsHr06mCV3I4XoDRMrNzf3cpYkXgDY5fDQEW_vHdz7FILuMichrVV1bMIlzVbcWWid-u5rrghbzahAyXgZTSfES1GXmnHHjlaWVmuXLGCtRUvyfw8GFyh8LX2v-nogkLFmfonDoDv03HqYcRv1xhmGsjU7vvRIW_oEGk927Tv7mRrVBS9n9ParIN30C0AoqOPq43S8cKQhISVUd_VZd9J78Fj9OpVOx_H-OVO-OW8UvdxmT71ArlPN6YLrHB7_AnZoV59_rHhhdaLyqhSjqe0t8ZEovTpf8XNGwOwrWu3sEuXczhuSbDVRGiHmqixqiYVL_5TebZQ0pqLSuZzGj2w6GjLJtwM3Cgxa4ltEfT8qMKkJE6Sj3mdZ0ETucs3i7BfMMzfu8b36hZeb5-K2wDfTOGSUSwtAfrnUCcmDzqTE8lwQj1Bnzrs8279nOqKsztmNS04L91zLyFK7HWV87tldGEO7uYhwFpCMV1cwU2jcZATjqrIF9DvhvHGd8bOiYdtoafh6zJvrNuRGtqrAz3rC73mADp0rfwRnOihaB8S6-6DgkQOZ0c94dbGYGYtNKNDO4IjRDZVarR-9yd3Bwr65nMZTNseWrkdDQ-pTOFL2rnCRrthqfxhDKviMZvGFVitKKsO0rlRNr5VbHLDSRJ5uNh5BU9bGJJA1bypK_5LvxbWvM4xw0em4fnXtWdnNWhyQ5IEZzpVvC8gaIO-cJvoio7u_lEzLdMMuA4CirNs-2XTUuysnVAK1f9Ub2YbMmzrKpfCaICLq4OD4rj5cr3pOOxMdZVc0-ZhS4p4_0eu8wR7-68BN0IgpYvKNOQRnyqL5JpIevcLmKh7QfmnFvCpHLuK04ZBZcd4H-gooyDw_up7SAkolvHA6isbx-ygO4lpcxou2Cn1oNs3e2qjP_TAIpnFwtRUE02mGGQsb2UBzE7ZgSmZJmWKYGZ1BvzdZJ0bAvadkICh7_wwmpRY5cbB553pm4c0XDCFGgodixgN-2nSw2xDE8HE0H9F5lRSFNQ115W0tXydtJ9D0kC9IoTfIIYMLoW1OvUL7CNrFJC1QB43bMzRh1o7c7ZDaM-v-sLbm3ohyLVIigpsBMrX-cXMdNbCXh3z16uQ7UXU4DQuSU4r1E4P7fU3UWA8CfCDCpHS4pbr8IQB3hs5dz9ONZSlTkTJrWeZxsuECXFAZoXNLes2tnwKRLD5bLc4ehs75OwoV5AYqlQekPE0CXihgqjWknSJD8dBNMZWGUb2UdnManLMXNyOmHl8Zdx47fZl6fsvS5X3n34_FaIcaHflw2iTlKsGu_NoKy3xfGnHVgPK2m_IuIW-3ZkTkdDQrsBArsl8u3MowAD6nxB9CUhc2ES0X8JmZsm9JfZ_sN9VKi5j2W07iSPmt_TP5PrGcacIOj6wYKRD6N-vXo64sB2q-pjPpOSeDYC7CM72mOhIcQQODTPxuAzNi0VbK6cvQVE8u9iPZMXt7uT2wUUvUQmFQYw3bQsgUAnChVg5SYAUfCj-88FPm5QYfxaRwNq9Zw-stzL6e7gq1_4f5wJiImKT2tOvOHbX1YOjdPMFUYkRHF8UPPNKMReIDy8k3-sSlPKEoxZZ4h-D83EEHHqbHgtEapBZxSbi2s25w5N_fRkt4C49Ad2cK5ge7LszkkUQff6P2VltBPk99dM5Wi5sgU8UI-1YaykO7z9UbrHmGOYRVTPvt5g_UfGq9tZM9HmDehFNqN0kkPzvWpaKL-bQREWsSOgCDibHDgAXEJIySLYl-I_Nc2I52a2W8tJ2z0hnDyOaupK4XHTA-V9iwG0KBnaQaKBqh-2R_gdr6R4SFPzgOMUNEOLiFsCjzdIOf1cOYOKPf6oOeiusCfAKlooyFVajOa5xb4Drup_6blGIPDBmNdrvUL4rPa3dDVS2DUOgc63uwqbM_e_q6LvrjeFFKkF1BAh2sAbfUzGLSrxztxTjapWRDvLqKhSwSKayHUEsaENo4hu8zXaRuQbw9kJ_zfk8XTkxj1ZU-7haViEsDYQPq1HVdQNjrBdqubRHi4HOMakOJcR7MqSmOSyXoh3385TL2GeQVomDaUO9bTquqCGBEOoi-LA1DqOrrwU8g8TxkDtiYwtW9pZGEMD58fdQnIrWNX-zDr4fmeo4e_i27i4n-n1wCaj4o8no52p4Q6k813mN4ADGZ9d6B8WyWEKRbvncmAaggD6aOWbhKjCud0H5WuuITlArDYJu3qFemY9K5ezUMxYKo" charset="UTF-8"></script><script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    * { box-sizing: border-box; }
    #map { flex: 1; height: 100vh; }
    .sidebar { transition: all 0.3s ease-in-out; }
    .sidebar.minimized { width: 0; overflow: hidden; padding: 0; }
    .sidebar.minimized .sidebar-content { display: none; }
    .sidebar-toggle {
      position: fixed; left: 320px; top: 10px; z-index: 100;
      background: #1f2937; border: 1px solid #374151; padding: 8px 12px;
      border-radius: 4px; cursor: pointer; color: #fff; font-weight: 700;
      transition: left 0.3s ease-in-out; white-space: nowrap;
    }
    .search-box {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 99; background: #fff; border: 2px solid #e5e7eb; border-radius: 8px;
      padding: 8px; width: auto; min-width: 300px; max-width: 500px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .search-box-content { 
      display: flex; gap: 4px; align-items: center; 
      flex-wrap: nowrap; overflow-x: auto;
    }
    .search-box input {
      flex: 1; min-width: 150px; padding: 8px 10px; background: #f9fafb; 
      border: 1px solid #e5e7eb; border-radius: 4px; color: #111827; 
      font-size: 0.85rem; font-family: inherit;
    }
    .search-box input::placeholder {
      color: #999; font-size: 0.8rem;
    }
    .search-suggestions {
      position: absolute; top: 100%; left: 0; right: 0; background: #fff; 
      border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 4px 4px;
      max-height: 200px; overflow-y: auto; z-index: 100; display: none; margin-top: -8px;
    }
    .search-suggestions.show { display: block; }
    .suggestion-item {
      padding: 10px 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; 
      font-size: 0.85rem; color: #333; white-space: nowrap; overflow: hidden; 
      text-overflow: ellipsis;
    }
    .suggestion-item:hover { background: #f3f4f6; }
    .search-btn { 
      background: #3b82f6; color: #fff; padding: 8px 10px; border-radius: 4px; 
      font-weight: 700; cursor: pointer; border: none; font-size: 1rem; flex-shrink: 0;
    }
    .search-btn:hover { background: #2563eb; }
    .pin-btn { 
      background: #06b6d4; color: #fff; padding: 8px 10px; border-radius: 4px; 
      font-weight: 700; cursor: pointer; border: none; font-size: 1rem; flex-shrink: 0;
    }
    .pin-btn:hover { background: #0891b2; }
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,.5); }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { 
      background: #1f2937; padding: 24px; border-radius: 8px; border: 1px solid #374151; 
      color: #fff; max-width: 420px; width: 90%; overflow-y: auto; max-height: 80vh; 
    }
    .status-active { color: #dc2626; }
    .status-contained { color: #eab308; }
    .status-extinguished { color: #22c55e; }
    .status-padam { color: #0ea5e9; }
    .footer-badge {
      position: fixed; bottom: 10px; left: 10px; background: #1f2937; 
      border: 1px solid #374151; color: #9ca3af; padding: 8px 12px; 
      border-radius: 4px; font-size: 0.75rem; z-index: 50; white-space: nowrap;
    }
    /* Zoom Controls - 50% Lebih Besar */
    .maplibregl-ctrl-top-right {
      top: 10px !important;
      right: 10px !important;
      transform: scale(1.5);
      transform-origin: top right;
    }
    .maplibregl-ctrl-bottom-right .maplibregl-ctrl-scale,
    .maplibregl-ctrl-bottom-left .maplibregl-ctrl-scale {
      transform: scale(1); transform-origin: bottom left; font-size: 11px; 
      padding: 3px 5px; border-width: 1px;
    }
    .fire-marker { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #fff; }
    .fire-item { 
      padding: 8px; border-radius: 4px; border: 1px solid #374151; 
      transition: all 0.2s; cursor: pointer; 
    }
    .fire-item:hover { background: #1f2937; }
    .fire-item.selected { background: #1e40af; border-color: #3b82f6; }
    .stats-box { 
      background: #1e293b; padding: 10px; border-radius: 6px; 
      border-left: 3px solid #0ea5e9; margin: 8px 0; 
    }
    .stat-row { 
      display: flex; justify-content: space-between; font-size: 0.9rem; 
      color: #d1d5db; padding: 4px 0; 
    }
    .stat-num { font-weight: 700; }
    .filter-btn { 
      padding: 6px 12px; border-radius: 4px; border: 1px solid #374151; 
      background: #1f2937; color: #fff; cursor: pointer; font-size: 0.85rem; 
      transition: all 0.2s; margin: 4px; 
    }
    .filter-btn.active { background: #3b82f6; border-color: #3b82f6; }
    .tabs { 
      display: flex; gap: 8px; margin-bottom: 12px; border-bottom: 1px solid #374151; 
      padding-bottom: 8px; 
    }
    .tab { 
      padding: 6px 12px; background: #374151; color: #d1d5db; border-radius: 4px; 
      cursor: pointer; font-size: 0.85rem; transition: all 0.2s; 
    }
    .tab.active { background: #3b82f6; color: #fff; }
  </style>
</head>
<body class="flex bg-gray-100 m-0 p-0">


  <div id="radiusModal" class="modal">
    <div class="modal-content">
      <h3 style="font-weight:700; font-size:1.05rem; margin-bottom:8px;">‚ö†Ô∏è Pilih Titik untuk Ubah Radius</h3>
      <p style="color:#d1d5db; font-size:0.95rem;">Klik pada pin di peta yang ingin diubah radiusnya, atau pilih di bawah:</p>
      <div id="modalTitikList" style="max-height:300px; overflow-y:auto; margin:16px 0; border:1px solid #374151; border-radius:4px; padding:8px;"></div>
      <div style="display:flex; gap:12px; margin-top:8px;">
        <button onclick="applyRadiusToAll()" style="flex:1; background:#3b82f6; color:#fff; padding:10px; border-radius:4px; font-weight:700; border:none; cursor:pointer;">‚úì Semua Titik</button>
        <button onclick="closeRadiusModal()" style="flex:1; background:#6b7280; color:#fff; padding:10px; border-radius:4px; font-weight:700; border:none; cursor:pointer;">‚úï Batal</button>
      </div>
    </div>
  </div>

  <div class="search-box">
    <div class="search-box-content">
      <input id="coordSearch" type="text" placeholder="Senayan, Jl. Sudirman, -6.17,106.82" />
      <button class="search-btn" onclick="searchLocation()" title="Cari">üîé</button>
      <button class="pin-btn" onclick="pinFromSearch()" title="Pin">üìç</button>
    </div>
    <div id="searchSuggestions" class="search-suggestions"></div>
  </div>

  <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">‚ò∞ Hide</button>

  <div class="w-80 bg-gray-900 text-white p-5 flex flex-col shadow-xl overflow-y-auto sidebar" id="sidebar" style="gap:10px; flex-shrink: 0;">
    <div class="sidebar-content" style="display:flex; flex-direction:column; gap:10px;">
      <div style="background:#0f172a; padding:10px; border-radius:6px; border-left:3px solid #0ea5e9;">
        <h2 class="text-xl font-bold">üî• Titik Kebakaran Jakarta</h2>
        <p style="font-size:0.75rem; color:#64748b; margin:4px 0 0 0;">v1.7.3 ‚Ä¢ Build Nov.2025</p>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('editor')">üìù Editor</div>
        <div class="tab" onclick="switchTab('stats')">üìä Stats</div>
      </div>

      <!-- EDITOR TAB -->
      <div id="editorTab" style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; flex-direction:column; gap:7px;">
          <label class="block text-sm text-gray-300">Nama Titik:</label>
          <input id="fireName" type="text" placeholder="Contoh: Kebakaran Pasar Baru" class="w-full px-3 py-2 rounded bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <div style="display:flex; flex-direction:column; gap:7px;">
          <label class="block text-sm text-gray-300">Radius Zona Bahaya (m):</label>
          <input id="radiusSlider" type="range" min="100" max="3000" step="50" value="500" class="w-full cursor-pointer accent-red-600" />
          <p id="radiusValue" class="text-xs text-gray-400 mt-1">Radius: 500 m</p>
        </div>

        <div style="display:flex; flex-direction:column; gap:7px;">
          <label class="block text-sm text-gray-300">Opacity Visualisasi:</label>
          <input id="opacitySlider" type="range" min="0.1" max="1" step="0.1" value="0.6" class="w-full cursor-pointer accent-gray-500" />
          <p id="opacityValue" class="text-xs text-gray-400 mt-1">Opacity: 0.6</p>
        </div>

        <div class="flex gap-2">
          <button id="addFire" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded font-semibold transition">‚ûï Tambah Titik</button>
          <button id="removeFire" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded font-semibold transition">‚ûñ Hapus Tititk</button>
        </div>

        <div class="flex gap-2">
          <button id="selectAll" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition">‚òëÔ∏è Pilih Semua</button>
          <button id="deselectAll" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm transition">‚òê Batal Pilih</button>
        </div>

        <div style="display:flex; flex-direction:column; gap:7px;">
          <label class="block text-sm text-gray-300">Status Kebakaran:</label>
          <select id="fireStatus" class="w-full px-3 py-2 rounded bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="active">üî• Aktif</option>
            <option value="contained">‚ö†Ô∏è Terkontrol</option>
            <option value="extinguished">‚úÖ Mereda</option>
            <option value="padam">‚ùÑÔ∏è Padam</option>
          </select>
        </div>

        <button id="implementStatus" class="w-full bg-amber-600 hover:bg-amber-700 py-2 rounded font-semibold transition text-sm">üîÑ Implementasi Status</button>

        <div class="flex gap-2">
          <button id="exportGeoJSON" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded text-sm font-semibold transition">üì• GeoJSON</button>
          <button id="exportCSV" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2 rounded text-sm font-semibold transition">üìä CSV</button>
        </div>

        <button id="clearAll" class="w-full bg-red-800 hover:bg-red-900 py-2 rounded font-semibold transition text-sm">üóëÔ∏è Hapus Semua</button>
      </div>

      <!-- STATS TAB -->
      <div id="statsTab" style="display:none; flex-direction:column; gap:10px;">
        <div class="stats-box">
          <div class="stat-row">
            <span>Total Titik:</span>
            <span class="stat-num" id="statTotal">0</span>
          </div>
          <div class="stat-row">
            <span>üî• Aktif:</span>
            <span class="stat-num status-active" id="statActive">0</span>
          </div>
          <div class="stat-row">
            <span>‚ö†Ô∏è Terkontrol:</span>
            <span class="stat-num status-contained" id="statContained">0</span>
          </div>
          <div class="stat-row">
            <span>‚úÖ Mereda:</span>
            <span class="stat-num status-extinguished" id="statExtinguished">0</span>
          </div>
          <div class="stat-row">
            <span>‚ùÑÔ∏è Padam:</span>
            <span class="stat-num status-padam" id="statPadam">0</span>
          </div>
        </div>

        <label class="block text-sm text-gray-300">Filter by Status:</label>
        <div style="display:flex; flex-wrap:wrap; gap:4px;">
          <button class="filter-btn active" onclick="filterByStatus('all')">Semua</button>
          <button class="filter-btn" onclick="filterByStatus('active')">üî• Aktif</button>
          <button class="filter-btn" onclick="filterByStatus('contained')">‚ö†Ô∏è Terkontrol</button>
          <button class="filter-btn" onclick="filterByStatus('extinguished')">‚úÖ Mereda</button>
          <button class="filter-btn" onclick="filterByStatus('padam')">‚ùÑÔ∏è Padam</button>
        </div>

        <div style="background:#1e293b; padding:12px; border-radius:6px; border-left:3px solid #0ea5e9; margin-top:12px;">
          <p style="font-size:0.8rem; color:#94a3bf; margin:0;">
            <b>üî• HEAT MAP</b><br>
            <span id="heatmapInfo" style="font-size:0.75rem;">Click filter to show density heat map on map</span>
          </p>
        </div>
      </div>

      <div style="background:#1e293b; padding:12px; border-radius:6px; border-left:3px solid #0ea5e9;">
        <p style="font-size:0.8rem; color:#94a3b8; margin:0;">
          <b>‚ÑπÔ∏è DATA REFERENSI:</b><br>
          üíß Hydrant: 12 titik (PDAM Jakarta)<br>
          üöí Pos Damkar: 5 titik (BPBD Jakarta)<br>
          üìç Digunakan untuk analisis jarak terdekat
        </p>
      </div>

      <h3 class="text-lg font-semibold">üìã Daftar Titik</h3>
      <div id="fireList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const APP_VERSION = "1.7.3";
    let currentFilterStatus = 'all';
    let radiusSliderTimeout;

    function switchTab(tab) {
      document.getElementById('editorTab').style.display = tab === 'editor' ? 'flex' : 'none';
      document.getElementById('statsTab').style.display = tab === 'stats' ? 'flex' : 'none';
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      updateStats();
    }
    window.switchTab = switchTab;

    function updateStats() {
      const stats = { total: firePoints.length, active: 0, contained: 0, extinguished: 0, padam: 0 };
      firePoints.forEach(p => { stats[p.status]++; });
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statActive').textContent = stats.active;
      document.getElementById('statContained').textContent = stats.contained;
      document.getElementById('statExtinguished').textContent = stats.extinguished;
      document.getElementById('statPadam').textContent = stats.padam;
    }
    window.updateStats = updateStats;

    function filterByStatus(status) {
      currentFilterStatus = status;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      updateFireListDisplay();
      if (status !== 'all') {
        document.getElementById('heatmapInfo').textContent = `Showing ${status === 'all' ? 'all' : status} fires on map...`;
      }
    }
    window.filterByStatus = filterByStatus;

    function updateFireListDisplay() {
      const items = document.querySelectorAll('.fire-item');
      items.forEach(item => {
        if (currentFilterStatus === 'all') {
          item.style.display = 'block';
        } else {
          const fireId = item.dataset.fireId;
          const point = firePoints.find(p => p.id === fireId);
          item.style.display = point && point.status === currentFilterStatus ? 'block' : 'none';
        }
      });
    }

    const map = new maplibregl.Map({
      container:'map',
      style:'https://api.maptiler.com/maps/dataviz/style.json?key=QzE5n1Srx1KNobGYlUC5',
      center:[106.8272,-6.1754], zoom:11
    });
    map.addControl(new maplibregl.NavigationControl(),'top-right');
    map.addControl(new maplibregl.ScaleControl({maxWidth:200, unit:'metric'}),'bottom-right');

    const posFireStations = [
      {name:'Pos Damkar Tebet', coord:[106.8272,-6.1754]},
      {name:'Pos Damkar Menteng', coord:[106.7881,-6.2088]},
      {name:'Pos Damkar Kramat Jati', coord:[106.8571,-6.1754]},
      {name:'Pos Damkar Kemang', coord:[106.7954,-6.2600]},
      {name:'Pos Damkar Mampang', coord:[106.8198,-6.2407]}
    ];
    const hydrantLocations = [
      [106.8200,-6.1700],[106.8300,-6.1800],[106.8100,-6.1600],
      [106.8400,-6.1900],[106.8050,-6.1750],[106.8350,-6.1850],
      [106.7900,-6.2100],[106.8250,-6.2200],[106.8150,-6.1950],
      [106.8500,-6.2050],[106.7950,-6.2300],[106.8450,-6.2150]
    ];

    let firePoints = [], selectedFireIds = [], lastSearchCoord = null, addingNewFire = false;

    const radiusSlider=document.getElementById('radiusSlider');
    const opacitySlider=document.getElementById('opacitySlider');
    const radiusValue=document.getElementById('radiusValue');
    const opacityValue=document.getElementById('opacityValue');
    const fireList=document.getElementById('fireList');
    const coordSearch=document.getElementById('coordSearch');
    const searchSuggestions=document.getElementById('searchSuggestions');

    function getDistance(a,b){
      const R=6371000, [lng1,lat1]=a,[lng2,lat2]=b;
      const dLat=(lat2-lat1)*Math.PI/180, dLng=(lng2-lng1)*Math.PI/180;
      const A = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    }
    function updateDistances(p){
      p.nearestHydrantDist=Math.min(...hydrantLocations.map(h=>getDistance(p.coord,h)));
      p.nearestStationDist=Math.min(...posFireStations.map(s=>getDistance(p.coord,s.coord)));
    }
    function metersToPixels(m,lat,z){
      const C=40075017, rad=lat*Math.PI/180, mpp=C*Math.cos(rad)/Math.pow(2,z+8);
      return m/mpp;
    }
    function getMarkerColor(s){
      return s==='active'?'#dc2626':s==='contained'?'#eab308':s==='extinguished'?'#22c55e':s==='padam'?'#0ea5e9':'#dc2626';
    }
    function createMarkerEl(color){
      const el=document.createElement('div');
      el.className='fire-marker';
      el.style.background=color; el.style.boxShadow=`0 0 0 3px ${color}33`;
      return el;
    }
    function getRingColor(i){ return [[255,0,0],[255,102,0],[255,255,0],[153,255,51],[0,255,0]][i-1]; }

    function toggleSidebar(){
      const sidebar=document.getElementById('sidebar');
      const toggle=document.getElementById('sidebarToggle');
      const isMin=sidebar.classList.toggle('minimized');
      toggle.textContent=isMin?'‚ò∞ Show':'‚ò∞ Hide';
      if(isMin){ toggle.style.left='10px'; } 
      else { toggle.style.left='320px'; }
    }
    window.toggleSidebar=toggleSidebar;

    function uploadPhotoForPoint(fireId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const point = firePoints.find(p => p.id === fireId);
            if (point) {
              point.photo = ev.target.result;
              updatePopupContent(point);
              saveAllData();
            }
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }
    window.uploadPhotoForPoint=uploadPhotoForPoint;

    function updatePopupContent(p){
      updateDistances(p);
      const emoji=p.status==='contained'?'‚ö†Ô∏è':p.status==='extinguished'?'‚úÖ':p.status==='padam'?'‚ùÑÔ∏è':'üî•';
      const statusText={active:'Aktif',contained:'Terkontrol',extinguished:'Mereda',padam:'Padam'}[p.status];
      const html=`
        <div style="min-width:300px">
          <div style="background:${getMarkerColor(p.status)};color:#fff;padding:8px;border-radius:4px;margin-bottom:8px;">
            <b style="font-size:1.05rem;">${emoji} ${p.name}</b><br><small>Status: ${statusText}</small>
          </div>
          <div style="font-size:.9rem;margin:6px 0;">
            <b>üìç Koordinat:</b><br>
            <span style="font-size:.85rem;color:#666;">Lat: ${p.coord[1].toFixed(6)}<br>Lng: ${p.coord[0].toFixed(6)}</span><br><br>
            <b>üìè Radius Zona:</b> ${p.radius}m
          </div>
          <hr style="margin:8px 0;border:1px solid #ddd;">
          <div style="background:#fef08a;padding:8px;border-radius:4px;margin:8px 0;font-size:.85rem;">
            <b>üíß Hydrant Terdekat:</b><br>
            ${p.nearestHydrantDist<600?`‚úì <span style="color:#10b981;font-weight:700;">${p.nearestHydrantDist.toFixed(0)}m</span>`:`‚ö†Ô∏è <span style="color:#dc2626;font-weight:700;">${(p.nearestHydrantDist/1000).toFixed(2)}km</span>`}
          </div>
          <div style="background:#fee2e2;padding:8px;border-radius:4px;margin:8px 0;font-size:.85rem;">
            <b>üöí Pos Damkar Terdekat:</b><br><span style="font-weight:700;">${(p.nearestStationDist/1000).toFixed(2)}km</span>
          </div>
          <div style="margin-top:8px;">
            <button onclick="uploadPhotoForPoint('${p.id}')" style="width:100%;padding:8px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:700;font-size:.9rem;">
              üì∑ ${p.photo?'Ganti':'Upload'} Foto
            </button>
          </div>
          ${p.photo ? `<img src="${p.photo}" alt="Foto" style="margin-top:8px;max-width:280px;border-radius:4px;border:2px solid #ddd;" />` : ''}
        </div>`;
      p.marker.setPopup(new maplibregl.Popup({maxWidth:'320px'}).setHTML(html));
    }

    function updateListItem(p){
      const li=document.querySelector(`[data-fire-id="${p.id}"]`); if(!li)return;
      const statusEl=li.querySelector('.status-indicator');
      const statusText={active:'Aktif',contained:'Terkontrol',extinguished:'Mereda',padam:'Padam'}[p.status];
      statusEl.textContent=statusText; statusEl.className=`text-xs status-indicator status-${p.status}`;
    }

    function addFireCircle(coord,name,radius,opacity,status=null){
      const layerId=`fire-${Date.now()}`, s=status||document.getElementById('fireStatus').value, z=map.getZoom();

      for(let i=5;i>=1;i--){
        const meters=radius*(i/5), [r,g,b]=getRingColor(i), px=metersToPixels(meters,coord[1],z);
        map.addSource(`${layerId}-src-${i}`,{type:'geojson',data:{type:'Feature',geometry:{type:'Point',coordinates:coord}}});
        map.addLayer({id:`${layerId}-layer-${i}`,type:'circle',source:`${layerId}-src-${i}`,
          paint:{'circle-radius':px,'circle-color':`rgb(${r},${g},${b})`,'circle-opacity':opacity*(1.1-(i-1)*0.12),
                 'circle-stroke-width':1+(1-opacity)*2.5,'circle-stroke-color':'#000','circle-stroke-opacity':Math.min(1,(1-opacity)*2.5+0.3)}});
      }

      const el=createMarkerEl(getMarkerColor(s));
      const marker=new maplibregl.Marker({element:el}).setLngLat(coord).addTo(map);

      const p={id:layerId,coord,name,layerId,marker,radius,photo:null,status:s,nearestHydrantDist:0,nearestStationDist:0};
      updatePopupContent(p); firePoints.push(p);

      const div=document.createElement('div'); div.className='fire-item'; div.dataset.fireId=layerId;
      const statusText={active:'Aktif',contained:'Terkontrol',extinguished:'Mereda',padam:'Padam'}[s];
      div.innerHTML=`
        <div class="flex items-start gap-2">
          <input type="checkbox" class="mt-1" />
          <div class="flex-1 cursor-pointer" onclick="flyToPoint('${layerId}')">
            <div class="font-semibold">${name}</div>
            <div class="text-xs text-gray-400">Lat: ${coord[1].toFixed(4)}, Lng: ${coord[0].toFixed(4)}</div>
            <div class="text-xs text-gray-400">Radius: <span id="radius-${layerId}">${radius}</span>m</div>
            <div class="text-xs status-indicator status-${s}">${statusText}</div>
          </div>
        </div>`;
      div.querySelector('input[type="checkbox"]').onchange=()=>toggleFireSelection(layerId,div);
      fireList.appendChild(div);
      updateStats();
    }

    map.on('zoom',()=>{
      const z=map.getZoom();
      firePoints.forEach(p=>{
        for(let i=1;i<=5;i++){
          const id=`${p.layerId}-layer-${i}`;
          if(map.getLayer(id)){
            const px=metersToPixels(p.radius*(i/5),p.coord[1],z);
            map.setPaintProperty(id,'circle-radius',px);
          }
        }
      });
    });

    function toggleFireSelection(id,el){
      const i=selectedFireIds.indexOf(id);
      if(i>-1){selectedFireIds.splice(i,1); el.classList.remove('selected');}
      else {selectedFireIds.push(id); el.classList.add('selected');}
    }
    window.flyToPoint=function(id){
      const p=firePoints.find(x=>x.id===id); if(!p)return;
      map.flyTo({center:p.coord, zoom:15, duration:1000});
      setTimeout(()=>p.marker.togglePopup(),1000);
    };

    radiusSlider.oninput=()=>{ 
      if(addingNewFire)return;
      radiusValue.textContent=`Radius: ${parseInt(radiusSlider.value)} m`;
      clearTimeout(radiusSliderTimeout);
      radiusSliderTimeout = setTimeout(() => {
        if(firePoints.length > 0) {
          openRadiusModal();
        }
      }, 300);
    };

    opacitySlider.oninput=()=>{
      const op=parseFloat(opacitySlider.value); opacityValue.textContent=`Opacity: ${op}`;
      firePoints.forEach(p=>{
        for(let i=1;i<=5;i++){
          const id=`${p.layerId}-layer-${i}`; if(!map.getLayer(id))continue;
          map.setPaintProperty(id,'circle-opacity',op*(1.1-(i-1)*0.12));
          map.setPaintProperty(id,'circle-stroke-width',1+(1-op)*2.5);
          map.setPaintProperty(id,'circle-stroke-opacity',Math.min(1,(1-op)*2.5+0.3));
        }
      });
    };

    coordSearch.addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      if(query.length < 2) {
        searchSuggestions.classList.remove('show');
        return;
      }

      if(query.includes(',')) {
        const parts = query.split(',');
        if(parts.length === 2) {
          const lat = parseFloat(parts[0].trim());
          const lng = parseFloat(parts[1].trim());
          if(!isNaN(lat) && !isNaN(lng)) {
            searchSuggestions.classList.remove('show');
            return;
          }
        }
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&countrycodes=id`);
        const results = await response.json();
        
        if(results.length === 0) {
          searchSuggestions.innerHTML = '<div class="suggestion-item">‚ùå Tidak ada hasil</div>';
          searchSuggestions.classList.add('show');
          return;
        }

        searchSuggestions.innerHTML = results.map((r, idx) => 
          `<div class="suggestion-item" onclick="selectSearchResult(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}')">
            üìç ${r.display_name.split(',').slice(0,2).join(',')}
          </div>`
        ).join('');
        searchSuggestions.classList.add('show');
      } catch(err) {
        console.error('Geocoding error:', err);
        searchSuggestions.classList.remove('show');
      }
    });

    window.selectSearchResult = function(lat, lon, name) {
      lastSearchCoord = [lon, lat];
      coordSearch.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      searchSuggestions.classList.remove('show');
    };

    window.searchLocation = function() {
      const input = coordSearch.value.trim();
      
      if(input.includes(',')) {
        const parts = input.split(',');
        if(parts.length >= 2) {
          const lat = parseFloat(parts[0].trim());
          const lng = parseFloat(parts[1].trim());
          if(!isNaN(lat) && !isNaN(lng)) {
            lastSearchCoord = [lng, lat];
            map.flyTo({center:lastSearchCoord, zoom:16, duration:1000});
            new maplibregl.Marker({element:createMarkerEl('orange')}).setLngLat(lastSearchCoord).addTo(map);
            alert('‚úì Lokasi ditemukan. Klik üìç untuk menaruh pin kebakaran.');
            return;
          }
        }
      }
      
      alert('‚ùå Format tidak valid! Coba: "Senayan", "Jl. Sudirman", atau "-6.17,106.82"');
    };

    window.pinFromSearch = function() {
      if(!lastSearchCoord){alert('‚ö†Ô∏è Cari lokasi dulu');return;}
      const name=document.getElementById('fireName').value||`Kebakaran (${lastSearchCoord[1].toFixed(4)}, ${lastSearchCoord[0].toFixed(4)})`;
      addFireCircle(lastSearchCoord,name,parseInt(radiusSlider.value),0.6);
      document.getElementById('fireName').value=''; coordSearch.value='';
      searchSuggestions.classList.remove('show');
      saveAllData(); updateStats(); alert('‚úì Pin kebakaran ditambahkan');
    };

    function updateSelectedFireCircles(r){
      const z=map.getZoom();
      selectedFireIds.forEach(id=>{
        const p=firePoints.find(x=>x.id===id); if(!p)return;
        p.radius=r;
        for(let i=1;i<=5;i++){
          const src=`${p.layerId}-src-${i}`, lyr=`${p.layerId}-layer-${i}`;
          if(map.getSource(src)){
            const px=metersToPixels(r*(i/5),p.coord[1],z);
            map.getSource(src).setData({type:'Feature',geometry:{type:'Point',coordinates:p.coord}});
            if(map.getLayer(lyr)) map.setPaintProperty(lyr,'circle-radius',px);
          }
        }
        const rEl=document.getElementById(`radius-${p.id}`); if(rEl) rEl.textContent=r;
        updatePopupContent(p);
      });
    }
    function updateAllFireCircles(r){
      const z=map.getZoom();
      firePoints.forEach(p=>{
        p.radius=r;
        for(let i=1;i<=5;i++){
          const src=`${p.layerId}-src-${i}`, lyr=`${p.layerId}-layer-${i}`;
          if(map.getSource(src)){
            const px=metersToPixels(r*(i/5),p.coord[1],z);
            map.getSource(src).setData({type:'Feature',geometry:{type:'Point',coordinates:p.coord}});
            if(map.getLayer(lyr)) map.setPaintProperty(lyr,'circle-radius',px);
          }
        }
        const rEl=document.getElementById(`radius-${p.id}`); if(rEl) rEl.textContent=r;
        updatePopupContent(p);
      });
    }
    function openRadiusModal(){
      if(firePoints.length===0) return;
      const list=document.getElementById('modalTitikList'); list.innerHTML='';
      firePoints.forEach((p,idx)=>{
        const d=document.createElement('div');
        d.style.cssText='padding:8px;background:#374151;margin-bottom:8px;border-radius:4px;cursor:pointer;border:2px solid transparent;';
        d.innerHTML=`<div style="font-weight:700;">${idx+1}</div><div style="font-size:.85rem;color:#9ca3af;">Lat: ${p.coord[1].toFixed(4)}, Lng: ${p.coord[0].toFixed(4)}</div>`;
        d.onmouseover=()=>d.style.borderColor='#3b82f6'; d.onmouseout=()=>d.style.borderColor='transparent';
        d.onclick=()=>{selectedFireIds=[p.id]; applyRadiusToSelected();};
        list.appendChild(d);
      });
      document.getElementById('radiusModal').classList.add('show');
      firePoints.forEach(p=>{
        const el=p.marker.getElement(); el.dataset.__orig=JSON.stringify({bg:el.style.background,ring:el.style.boxShadow});
        el.style.background='orange'; el.style.boxShadow='0 0 0 3px #ffa50055';
      });
    }
    window.openRadiusModal=openRadiusModal;
    
    function closeRadiusModal(){
      document.getElementById('radiusModal').classList.remove('show');
      firePoints.forEach(p=>{
        const el=p.marker.getElement();
        if(el.dataset.__orig){
          const o=JSON.parse(el.dataset.__orig);
          el.style.background=o.bg; el.style.boxShadow=o.ring; delete el.dataset.__orig;
        } else {
          const c=getMarkerColor(p.status); el.style.background=c; el.style.boxShadow=`0 0 0 3px ${c}33`;
        }
      });
    }
    window.closeRadiusModal=closeRadiusModal;
    
    function applyRadiusToSelected(){ if(selectedFireIds.length===0){alert('‚ö†Ô∏è Pilih titik dulu!');return;} updateSelectedFireCircles(parseInt(radiusSlider.value)); closeRadiusModal(); alert('‚úì Radius diterapkan'); }
    window.applyRadiusToSelected=applyRadiusToSelected;
    
    function applyRadiusToAll(){ updateAllFireCircles(parseInt(radiusSlider.value)); closeRadiusModal(); alert('‚úì Radius diterapkan ke semua titik'); }
    window.applyRadiusToAll=applyRadiusToAll;

    document.getElementById('selectAll').onclick=()=>{ selectedFireIds=firePoints.map(p=>p.id); document.querySelectorAll('.fire-item').forEach(i=>{i.classList.add('selected'); i.querySelector('input[type="checkbox"]').checked=true;}); };
    document.getElementById('deselectAll').onclick=()=>{ selectedFireIds=[]; document.querySelectorAll('.fire-item').forEach(i=>{i.classList.remove('selected'); i.querySelector('input[type="checkbox"]').checked=false;}); };

    document.getElementById('implementStatus').onclick=()=>{
      if(selectedFireIds.length===0){alert('‚ö†Ô∏è Pilih minimal 1 titik');return;}
      const newS=document.getElementById('fireStatus').value;
      selectedFireIds.forEach(id=>{
        const p=firePoints.find(x=>x.id===id); if(!p)return;
        p.status=newS; const el=p.marker.getElement(); const col=getMarkerColor(newS);
        el.style.background=col; el.style.boxShadow=`0 0 0 3px ${col}33`;
        updatePopupContent(p); updateListItem(p);
      });
      saveAllData(); updateStats(); alert('‚úì Status berhasil diperbarui');
      selectedFireIds=[]; document.querySelectorAll('.fire-item').forEach(i=>{i.classList.remove('selected'); i.querySelector('input[type="checkbox"]').checked=false;});
    };

    function saveAllData(){
      const data=firePoints.map(p=>({coord:p.coord,name:p.name,radius:p.radius,photo:p.photo,status:p.status,timestamp:new Date().toISOString()}));
      localStorage.setItem('fireIncidentsJakarta',JSON.stringify(data));
    }

    document.getElementById('addFire').onclick=()=>{
      addingNewFire=true;
      map.once('click',(e)=>{
        const name=document.getElementById('fireName').value||'Titik Tanpa Nama';
        addFireCircle(e.lngLat.toArray(),name,parseInt(radiusSlider.value),0.6);
        document.getElementById('fireName').value=''; saveAllData(); addingNewFire=false;
      });
      alert('Klik di peta untuk menambahkan titik üî•');
    };

    document.getElementById('removeFire').onclick=()=>{
      if(selectedFireIds.length>0){
        selectedFireIds.forEach(id=>{
          const idx=firePoints.findIndex(p=>p.id===id); if(idx===-1)return;
          const p=firePoints[idx];
          for(let i=1;i<=5;i++){ if(map.getLayer(`${p.layerId}-layer-${i}`)) map.removeLayer(`${p.layerId}-layer-${i}`); if(map.getSource(`${p.layerId}-src-${i}`)) map.removeSource(`${p.layerId}-src-${i}`); }
          p.marker.remove(); firePoints.splice(idx,1);
        });
        fireList.innerHTML=''; selectedFireIds=[];
        firePoints.forEach(p=>{
          const div=document.createElement('div'); div.className='fire-item'; div.dataset.fireId=p.id;
          const statusText={active:'Aktif',contained:'Terkontrol',extinguished:'Mereda',padam:'Padam'}[p.status];
          div.innerHTML=`<div class="flex items-start gap-2">
            <input type="checkbox" class="mt-1" />
            <div class="flex-1 cursor-pointer" onclick="flyToPoint('${p.id}')">
              <div class="font-semibold">${p.name}</div>
              <div class="text-xs text-gray-400">Lat: ${p.coord[1].toFixed(4)}, Lng: ${p.coord[0].toFixed(4)}</div>
              <div class="text-xs text-gray-400">Radius: <span id="radius-${p.id}">${p.radius}</span>m</div>
              <div class="text-xs status-indicator status-${p.status}">${statusText}</div>
            </div></div>`;
          div.querySelector('input[type="checkbox"]').onchange=()=>toggleFireSelection(p.id,div);
          fireList.appendChild(div);
        });
        saveAllData(); updateStats();
      } else {
        const last=firePoints.pop(); if(!last)return;
        for(let i=1;i<=5;i++){ if(map.getLayer(`${last.layerId}-layer-${i}`)) map.removeLayer(`${last.layerId}-layer-${i}`); if(map.getSource(`${last.layerId}-src-${i}`)) map.removeSource(`${last.layerId}-src-${i}`); }
        last.marker.remove(); if(fireList.lastChild) fireList.removeChild(fireList.lastChild); saveAllData(); updateStats();
      }
    };

    document.getElementById('exportGeoJSON').onclick = () => {
      const geojson = { type:'FeatureCollection', features:firePoints.map(p=>({type:'Feature', geometry:{type:'Point',coordinates:p.coord}, properties:{name:p.name,radius:p.radius,status:p.status,timestamp:new Date().toISOString()}})) };
      const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `kebakaran-jakarta-${new Date().toISOString().split('T')[0]}.geojson`;
      a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('exportCSV').onclick = () => {
      let csv = 'No,Nama,Latitude,Longitude,Radius(m),Status,Hydrant(m),Damkar(km)\n';
      firePoints.forEach((p, idx) => {
        csv += `${idx+1},"${p.name}",${p.coord[1]},${p.coord[0]},${p.radius},"${p.status}",${p.nearestHydrantDist.toFixed(0)},${(p.nearestStationDist/1000).toFixed(2)}\n`;
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `kebakaran-jakarta-${new Date().toISOString().split('T')[0]}.csv`;
      a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('clearAll').onclick = () => {
      if (confirm('‚ö†Ô∏è Yakin ingin menghapus SEMUA data? (Tidak bisa di-undo!)')) {
        firePoints = []; selectedFireIds = []; fireList.innerHTML = '';
        localStorage.removeItem('fireIncidentsJakarta');
        updateStats();
        alert('‚úì Data berhasil dihapus');
      }
    };
  </script>
</body>
</html>
